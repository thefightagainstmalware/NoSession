#include <jni.h>
#include <windows.h>
#include "sandbox/win/src/sandbox.h"
#include "sandbox/win/src/sandbox_factory.h"

LPWSTR convertJObjectArrayToLPWSTR(JNIEnv *env, jobjectArray args) {
    int count = 0;
    for (jsize i = 0; i < env->GetArrayLength(args); i++) {
        auto str = (jstring) env->GetObjectArrayElement(args, i);
        count += env->GetStringLength(str);
        count++; // space char
    }
    count++;
    auto combinedString = new WCHAR[count];
    int index = 0;
    for (jsize i = 0; i < env->GetArrayLength(args); i++) {
        auto str = (jstring) env->GetObjectArrayElement(args, i);
        const jchar* chars = env->GetStringChars(str, nullptr);
        for (jsize j = 0; j < env->GetStringLength(str); j++) {
            combinedString[index] = chars[j];
        }
        env->ReleaseStringChars(str, chars);
    }
}

bool runParent(JNIEnv *env, sandbox::BrokerServices *broker_service, jobjectArray rwMounts, jobjectArray roMounts, jobjectArray args) {
    if (0 != broker_service->Init()) {
        return false;
    }

    PROCESS_INFORMATION pi;

    std::unique_ptr<sandbox::TargetPolicy> policy = broker_service->CreatePolicy();
    sandbox::TargetConfig *config = policy->GetConfig();

    // Here's where you set the security level of the sandbox. Doing a "goto definition" on any
    // of these symbols usually gives you a good description of their usage and alternatives.
    config->SetJobLevel(sandbox::JobLevel::kLockdown, 0);
    config->SetTokenLevel(sandbox::USER_RESTRICTED_SAME_ACCESS, sandbox::USER_LOCKDOWN);
    config->SetDesktop(sandbox::Desktop::kAlternateDesktop);
    config->SetDelayedIntegrityLevel(sandbox::INTEGRITY_LEVEL_LOW);

    //Add additional rules here
    for (jsize i = 0; i < env->GetArrayLength(rwMounts); i++) {
        auto str = (jstring) env->GetObjectArrayElement(rwMounts, i);
        const jchar* chars = env->GetStringChars(str, nullptr);
        config->AddRule(sandbox::SubSystem::kFiles, sandbox::Semantics::kFilesAllowAny,
                        reinterpret_cast<const wchar_t *>(chars));
    }
    for (jsize i = 0; i < env->GetArrayLength(roMounts); i++) {
        auto str = (jstring) env->GetObjectArrayElement(roMounts, i);
        const jchar *chars = env->GetStringChars(str, nullptr);
        config->AddRule(sandbox::SubSystem::kFiles, sandbox::Semantics::kFilesAllowReadonly,
                        reinterpret_cast<const wchar_t *>(chars));
    }
    auto exe = (jstring) env->GetObjectArrayElement(args, 0);
    const jchar *exeChars = env->GetStringChars(exe, nullptr);
    broker_service->SpawnTarget(reinterpret_cast<const wchar_t *>(exeChars), GetCommandLineW(), std::move(policy), nullptr, &pi);
    // Just like CreateProcess, you need to close these yourself unless you need to reference them later
    CloseHandle(pi.hThread);
    CloseHandle(pi.hProcess);
    return true;
}

#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     gq_malwarefight_nosession_win_WindowsSandbox
 * Method:    initSandbox
 * Signature: ([Ljava/lang/String;[Ljava/lang/String;)Z
 */
JNIEXPORT jboolean JNICALL Java_gq_malwarefight_nosession_win_WindowsSandbox_initParent
        (JNIEnv *env, jclass, jobjectArray rwMounts, jobjectArray roMounts, jobjectArray args) {
    sandbox::BrokerServices *broker_service = sandbox::SandboxFactory::GetBrokerServices();
    if (broker_service != nullptr) {
        // parent
        return runParent(env, broker_service, rwMounts, roMounts, args);
    } else {
        // child
        env->ThrowNew(env->FindClass("java/lang/Exception"), "Called initParent from child");
    }
}

JNIEXPORT jboolean JNICALL Java_gq_malwarefight_nosession_win_WindowsSandbox_initChild
        (JNIEnv *env, jclass) {
    sandbox::BrokerServices *broker_service = sandbox::SandboxFactory::GetBrokerServices();
    if (broker_service != nullptr) {
        // parent
        env->ThrowNew(env->FindClass("java/lang/Exception"), "Called initChild from parent");
    } else {
        // child

    }
}

JNIEXPORT jboolean JNICALL Java_gq_malwarefight_nosession_win_WindowsSandbox_isSandboxed
        (JNIEnv *, jclass) {
    sandbox::BrokerServices *broker_service = sandbox::SandboxFactory::GetBrokerServices();
    return broker_service == nullptr;
}

#ifdef __cplusplus
}
#endif
