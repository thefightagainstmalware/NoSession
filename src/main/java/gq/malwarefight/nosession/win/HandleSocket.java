package gq.malwarefight.nosession.win;

import com.sun.jna.platform.win32.WinNT;
import gq.malwarefight.tokenapp.SimpleSocket;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.nio.ByteBuffer;

public class HandleSocket implements SimpleSocket {
    private final WinNT.HANDLE handle;
    public HandleSocket(WinNT.HANDLE handle) {
        this.handle = handle;
    }
    @Override
    public InputStream getInputStream() throws IOException {
        return new InputStream() {
            @Override
            public int read() throws IOException {
                ByteBuffer buf = ByteBuffer.allocate(1);
                Kernel32.INSTANCE.ReadFile(handle, buf, 1, null, null);
                return buf.get(0);
            }
        };
    }

    @Override
    public OutputStream getOutputStream() throws IOException {
        return new OutputStream() {
            @Override
            public void write(int b) throws IOException {
                Kernel32.INSTANCE.WriteFile(handle, new byte[]{(byte) b}, 1, null, null);
            }
        };
    }

    @Override
    public void close() throws IOException {
        Kernel32.INSTANCE.CloseHandle(handle);
    }
}
